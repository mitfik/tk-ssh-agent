clone:
  depth: 1
pipelines:
  default:
    - step:
        image:
          name: golang:latest
        script:
          - git submodule update --init
          - export GOPATH=`pwd`/go
          - export CGO_ENABLED=0
          - mkdir -p out

          - env GOOS=linux GOARCH=amd64 make
          - mv tk-ssh-agent out/tk-ssh-agent-x86_64-linux

          - env GOOS=darwin GOARCH=amd64 make
          - mv tk-ssh-agent out/tk-ssh-agent-x86_64-darwin

          - apt-get update
          - apt-get install -y checkinstall upx
          - make deb

          - export DEBFILE=`ls | grep -P '\.deb$' | head -n 1`

          - curl -X POST --user "${BB_AUTH_STRING}" "https://api.bitbucket.org/2.0/repositories/trustedkey/tk-ssh-agent/downloads" --form files=@"./out/tk-ssh-agent-x86_64-linux"
          - curl -X POST --user "${BB_AUTH_STRING}" "https://api.bitbucket.org/2.0/repositories/trustedkey/tk-ssh-agent/downloads" --form files=@"./out/tk-ssh-agent-x86_64-darwin"
          - curl -X POST --user "${BB_AUTH_STRING}" "https://api.bitbucket.org/2.0/repositories/trustedkey/tk-ssh-agent/downloads" --form files=@"./${DEBFILE}"
